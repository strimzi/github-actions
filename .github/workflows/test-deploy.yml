name: Test Deploy Actions

on:
  pull_request:
    branches:
      - "*"
  push:
    branches:
      - "main"
      # Remove this after testing
      - "extract-actions"
    tags:
      - "*"

# Declare default permissions as read only
permissions:
  contents: read

# Cancel previous builds on the same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-deploy-java-with-local-repo:
    name: Test deploy-java for ${{ matrix.project.repo }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project:
          - repo: strimzi/strimzi-kafka-operator
            artifactName: strimzi-binaries
            modules: "./,crd-annotations,crd-generator,test,api,v1-api-conversion"
            nexusCheck: "api"
            javaVersion: "21"
          - repo: strimzi/strimzi-kafka-bridge
            artifactName: strimzi-bridge
            modules: "./"
            nexusCheck: "kafka-bridge"
            javaVersion: "17"
    steps:
      # Checkout bridge for integration test
      - name: Checkout ${{ matrix.project.repo }}
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.project.repo }}

      - name: Checkout github-actions
        uses: actions/checkout@v4
        with:
          path: github-actions

      - name: Setup Nexus
        run: github-actions/.github/tests/setup-nexus.sh
        env:
          NEXUS_URL: "http://localhost:8081"
          NEXUS_IMAGE: "sonatype/nexus3:3.87.2"
          SETTINGS_DIR: "github-actions/.github/tests/"

      - name: Setup actions for testing
        run: |
          mkdir -p .github/actions
          cp -r github-actions/.github/actions/* .github/actions/

      - name: Build binaries using build-binaries action
        uses: ./.github/actions/build/build-binaries
        with:
          javaVersion: ${{ matrix.project.javaVersion }}
          mainBuild: "true"
          artifactName: ${{ matrix.project.artifactName }}
        env:
          MVN_ARGS: "-DskipTests"

      - name: Verify binaries artifact was created
        run: |
          if [ ! -f "${{ matrix.project.artifactName }}.tar" ]; then
            echo "❌ Binaries artifact not created"
            exit 1
          fi

          echo "Binaries artifact contents:"
          tar -tf ${{ matrix.project.artifactName }}.tar
          echo "✓ Binaries artifact created successfully"

      - name: Generate GPG key for testing
        run: |
          # Create a test GPG key (non-interactive)
          cat > gpg-key-config <<EOF
          %no-protection
          Key-Type: RSA
          Key-Length: 2048
          Name-Real: Test User
          Name-Email: test@strimzi.io
          Expire-Date: 0
          EOF

          gpg --batch --gen-key gpg-key-config

          # Export the key
          gpg --armor --export-secret-keys test@strimzi.io > test-gpg-key.asc

          # Encode to base64
          GPG_KEY_BASE64=$(cat test-gpg-key.asc | base64 -w 0)
          echo "GPG_SIGNING_KEY=$GPG_KEY_BASE64" >> $GITHUB_ENV

          echo "✓ GPG key generated for testing"

      - name: Deploy to local Maven repository using deploy-java action
        uses: ./.github/actions/build/deploy-java
        with:
          javaVersion: ${{ matrix.project.javaVersion }}
          settingsPath: "${{ github.workspace }}/github-actions/.github/tests/settings.xml"
          projects: ${{ matrix.project.modules }}
          artifactName: "${{ matrix.project.artifactName }}.tar"
          gpgPassphrase: "test-passphrase"
          gpgSigningKey: ${{ env.GPG_SIGNING_KEY }}
          centralUsername: "admin"
          centralPassword: ${{ env.NEXUS_PASSWORD }}
          deploymentUrl: "http://localhost:8081/repository"

      - name: Verify deployment to Nexus
        run: |
          echo ">>> Verifying deployment in Nexus..."
          TIMEOUT=180  # 3 minutes
          INTERVAL=5   # Check every 5 seconds
          ELAPSED=0

          while [ $ELAPSED -lt $TIMEOUT ]; do
              echo "Checking for artifacts... (${ELAPSED}s/${TIMEOUT}s)"
              
              SEARCH_RESULT=$(curl -s -u admin:${{ env.NEXUS_PASSWORD }} \
                  "http://localhost:8081/service/rest/v1/search?repository=maven-snapshots&group=io.strimzi&name=${{ matrix.project.nexusCheck }}" 2>/dev/null)
              
              ARTIFACT_COUNT=$(echo "$SEARCH_RESULT" | jq -r '.items | length' 2>/dev/null || echo "0")
              
              if [ "$ARTIFACT_COUNT" -gt 0 ]; then
                  echo "✓ Found $ARTIFACT_COUNT artifact(s) deployed!"
                  echo ""
                  echo "Deployed artifacts:"
                  echo "$SEARCH_RESULT" | jq '.items[] | {name: .name, version: .version, repository: .repository, assets: [.assets[].path]}'
                  exit 0
              fi
              
              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
          done

          echo "❌ Timeout: No artifacts found in maven-snapshots after ${TIMEOUT} seconds"
          echo "Last search result:"
          echo "$SEARCH_RESULT" | jq '.' || echo "No valid response"
          exit 1